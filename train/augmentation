def rotate_random(img):
    """Rotate an image between 0 and 15 degrees."""

    rotation = np.random.randint(0, 16)
    return scipy.ndimage.rotate(img, rotation, mode='nearest')


def crop_random(img):
    """Remove between 3 and 98 pixels from each of the borders."""

    x_left, x_right, y_top, y_bottom = np.random.randint(3, 99, 4)
    return img[y_top:-y_bottom, x_left:-x_right, :]


def flip_random(img):
    """Randomly flip an image up-down and/or left-right."""

    tmp = img.copy()

    if np.random.choice((0, 1)):
        tmp = np.fliplr(tmp)

    if np.random.choice((0, 1)):
        tmp = np.flipud(tmp)

    return tmp


def gamma_random(img):
    """Randomly set the gamma of an image between 0.5 and 2.0
    of its original value."""

    tmp = np.float32(img)
    inv_gamma = np.random.uniform(0.5, 2.0)
    tmp = 255 * (tmp / 255)**(1 / inv_gamma)
    tmp = np.uint8(tmp)
    return tmp


def resize(img):
    """Resize an image to 224x224."""

    tmp = scipy.misc.imresize(img, (224, 224))
    return tmp


def augment(img):
    """Randomly apply a rotation, crop, flip and gamma adjustment,
    in a random order."""

    tmp = img

    transformations = [rotate_random, crop_random, flip_random, gamma_random]
    np.random.shuffle(transformations)

    for tr in transformations:
        tmp = tr(tmp)

    tmp = resize(tmp)
    return tmp
